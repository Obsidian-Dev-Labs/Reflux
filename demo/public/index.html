<!DOCTYPE html>
<html>
  <head>
    <title>Dusk</title>
    <style>
      :root {
        --input-height: 48px;
      }

      @font-face {
        font-family: "Inter";
        src: url(./Inter.ttf);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        background-color: #1a1a1a;
        font-family: "Inter";
      }

      .top-bar {
        width: 100%;
        display: flex;
        align-items: center;
        padding: 10px;
        gap: 6px;
      }

      .top-bar div {
        height: var(--input-height);
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        background-color: #ffffff28;
        border: 2px solid #ffffff28;
        border-radius: 10px;
        transition: 150ms ease-in-out;
      }

      .top-bar div.focused {
        border-color: #ffffff80;
      }

      .top-bar div:hover {
        border-color: #ffffff60;
      }

      .top-bar input {
        width: 100%;
        height: 100%;
        background-color: transparent;
        border: none;
        color: #ffffffcd;
        padding-left: 8px;
        font-weight: 600;
        font-size: 18px;
        line-height: 1;
        outline: none;
      }

      .top-bar input::placeholder {
        color: #ffffff80;
        font-weight: 450;
      }

      .top-bar button {
        display: flex;
        align-items: center;
        justify-content: center;
        height: max-content;
        margin-right: 4px;
        padding: 4px;
        background-color: #ffffff28;
        color: #ffffffcd;
        border: 2px solid #ffffff28;
        border-radius: 8px;
        font-weight: 550;
        font-size: 18px;
        cursor: pointer;
      }

      .top-bar button svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }

      .iframe-container {
        width: 100%;
        height: calc(100vh - 50px);
        position: relative;
      }

      #frame {
        width: 100%;
        height: 100%;
        border: none;
      }
    </style>
    <script src="/baremux/index.js"></script>
    <script src="/scram/scramjet.controller.js"></script>
  </head>
  <body>
    <div class="top-bar">
      <div>
        <input
          autofocus
          autocapitalize="false"
          id="input"
          type="text"
          placeholder="Enter something..."
        />
        <button>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
    </div>

    <div class="iframe-container">
      <iframe id="frame" src="./home.html"></iframe>
    </div>
  </body>
</html>

<script>
  (async () => {
    function search(input) {
      input = input.trim();
      const searchTemplate = "https://www.duckduckgo.com/?q=%s";
      try {
        return new URL(input).toString();
      } catch (err) {
        try {
          const url = new URL(`http://${input}`);
          if (url.hostname.includes(".")) {
            return url.toString();
          }
          throw new Error("Invalid hostname");
        } catch (err) {
          return searchTemplate.replace("%s", encodeURIComponent(input));
        }
      }
    }

    const scramjet = new ScramjetController({
      prefix: "/scram/route/",
      files: {
        wasm: "/scram/scramjet.wasm.wasm",
        worker: "/scram/scramjet.worker.js",
        client: "/scram/scramjet.client.js",
        shared: "/scram/scramjet.shared.js",
        sync: "/scram/scramjet.sync.js",
      },
      flags: {
        rewriterLogs: true,
      },
    });

    scramjet.init();
    navigator.serviceWorker.register("/sw.js");

    const inputcontainer = document.querySelector(".top-bar div");
    const input = document.getElementById("input");
    const frame = document.getElementById("frame");
    const enter = document.querySelector(".top-bar button");

    enter.addEventListener("click", function () {
      if (input.value) {
        const value = input.value.trim();
        const searchUrl = search(value);
        frame.src = "/ob/route/" + encodeURIComponent(search(searchUrl));
      }
    });

    input.addEventListener("focus", () => {
      inputcontainer.classList.add("focused");
    });

    input.addEventListener("blur", () => {
      inputcontainer.classList.remove("focused");
    });

    input.addEventListener("keypress", function (e) {
      if (e.target.value && e.key == "Enter") {
        e.preventDefault();
        const value = e.target.value.trim();
        const searchUrl = search(value);

        if (value) {
          frame.src = "/scram/route/" + encodeURIComponent(search(searchUrl));
        }
      }
    });

    const control = new MessageChannel();

    const connection = new window.BareMux.BareMuxConnection(
      "/baremux/worker.js"
    );
    await connection.setTransport(
      "/reflux/index.mjs",
      [
        {
          transport: "/epoxy/index.mjs",
          wisp: "wss://gointospace.app/wisp/",
          controlPort: control.port1,
        },
      ],
      [control.port1]
    );

    const client = new window.BareMux.BareClient();
    const response = await client.fetch("https://example.com");
    console.log("Response from example.com:", await response.text());

    window.BMClient = client;
    window.BMConnection = connection;

    function injectDiscordHeadMiddleware() {
      return {
        onResponse: async ({ request, response }, next) => {
          if (
            request.remote.hostname === "discord.com" &&
            response.headers["content-type"]?.includes("text/html")
          ) {
            let originalHtml = response.body;

            // Ensure response.body is a string
            if (typeof originalHtml !== "string") {
              originalHtml = (await response.body.text?.()) ?? "";
            }

            const injectedScript = `
<link rel="stylesheet" href="https://github.com/Vendicated/Vencord/releases/download/devbuild/browser.css">
<script src="https://github.com/Vendicated/Vencord/releases/download/devbuild/browser.js"><\/script>`;

            const modifiedHtml = originalHtml.replace(
              "</head>",
              injectedScript + "</head>"
            );

            response.body = modifiedHtml;
            response.headers["content-length"] = String(modifiedHtml.length);
            response.headers["content-type"] = "text/html";

            console.log("[middleware] Injected script into Discord head");
          }

          await next();
        },
      };
    }

    control.port2.postMessage({
      type: "addMiddleware",
      id: "inject-discord-head",
      fn: `(${injectDiscordHeadMiddleware.toString()})()`,
    });
  })();
</script>
