<!DOCTYPE html>
<html>

<head>
  <title>Dusk</title>
  <style>
    :root {
      --input-height: 48px;
    }

    @font-face {
      font-family: "Inter";
      src: url(./Inter.ttf);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      background-color: #1a1a1a;
      font-family: "Inter";
    }

    .top-bar {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 10px;
      gap: 6px;
    }

    .top-bar div {
      height: var(--input-height);
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      background-color: #ffffff28;
      border: 2px solid #ffffff28;
      border-radius: 10px;
      transition: 150ms ease-in-out;
    }

    .top-bar div.focused {
      border-color: #ffffff80;
    }

    .top-bar div:hover {
      border-color: #ffffff60;
    }

    .top-bar input {
      width: 100%;
      height: 100%;
      background-color: transparent;
      border: none;
      color: #ffffffcd;
      padding-left: 8px;
      font-weight: 600;
      font-size: 18px;
      line-height: 1;
      outline: none;
    }

    .top-bar input::placeholder {
      color: #ffffff80;
      font-weight: 450;
    }

    .top-bar button {
      display: flex;
      align-items: center;
      justify-content: center;
      height: max-content;
      margin-right: 4px;
      padding: 4px;
      background-color: #ffffff28;
      color: #ffffffcd;
      border: 2px solid #ffffff28;
      border-radius: 8px;
      font-weight: 550;
      font-size: 18px;
      cursor: pointer;
    }

    .top-bar button svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    .iframe-container {
      width: 100%;
      height: calc(100vh - 50px);
      position: relative;
    }

    #frame {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <script src="/baremux/index.js"></script>
  <script src="/scram/scramjet.all.js"></script>
  <script src="/reflux/api.js"></script>
</head>

<body>
  <div class="top-bar">
    <div>
      <input autofocus autocapitalize="false" id="input" type="text" placeholder="Enter something..." />
      <button>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd"
            d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z"
            clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <div class="iframe-container">
    <iframe id="frame" src="./home.html"></iframe>
  </div>
</body>

</html>

<script>
  (async () => {
    function search(input) {
      input = input.trim();
      const searchTemplate = "https://www.duckduckgo.com/?q=%s";
      try {
        return new URL(input).toString();
      } catch (err) {
        try {
          const url = new URL(`http://${input}`);
          if (url.hostname.includes(".")) {
            return url.toString();
          }
          throw new Error("Invalid hostname");
        } catch (err) {
          return searchTemplate.replace("%s", encodeURIComponent(input));
        }
      }
    }

    const { ScramjetController } = $scramjetLoadController();

    const scramjet = new ScramjetController({
      prefix: "/scram/route/",
      files: {
        wasm: "/scram/scramjet.wasm.wasm",
        all: "/scram/scramjet.all.js",
        sync: "/scram/scramjet.sync.js",
      },
      flags: {
        rewriterLogs: false,
      },
    });

    scramjet.init();
    navigator.serviceWorker.register("/sw.js");

    const inputcontainer = document.querySelector(".top-bar div");
    const input = document.getElementById("input");
    const frame = document.getElementById("frame");
    const enter = document.querySelector(".top-bar button");

    enter.addEventListener("click", function () {
      if (input.value) {
        const value = input.value.trim();
        const searchUrl = search(value);
        frame.src = "/ob/route/" + encodeURIComponent(search(searchUrl));
      }
    });

    input.addEventListener("focus", () => {
      inputcontainer.classList.add("focused");
    });

    input.addEventListener("blur", () => {
      inputcontainer.classList.remove("focused");
    });

    input.addEventListener("keypress", function (e) {
      if (e.target.value && e.key == "Enter") {
        e.preventDefault();
        const value = e.target.value.trim();
        const searchUrl = search(value);

        if (value) {
          frame.src = "/scram/route/" + encodeURIComponent(search(searchUrl));
        }
      }
    });

    const control = new MessageChannel();
    console.log("Created control channel:", control);

    const connection = new window.BareMux.BareMuxConnection(
      "/baremux/worker.js"
    );
    
    console.log("Setting transport with control port...");
    await connection.setTransport(
      "/reflux/index.mjs",
      [
        {
          transport: "/epoxy/index.mjs",
          wisp: "wss://gointospace.app/wisp/",
          controlPort: control.port1,
        },
      ],
      [control.port1]
    );
    console.log("Transport set successfully");

    const client = new window.BareMux.BareClient();
    const response = await client.fetch("https://example.com");
    console.log("Response from example.com:", await response.text());
    console.log("Full response object:", response);

    window.BMClient = client;
    window.BMConnection = connection;

    const initializeRefluxAPI = () => {
      let RefluxAPIClass = null;
      
      if (window.RefluxAPIModule && window.RefluxAPIModule.RefluxAPI) {
        RefluxAPIClass = window.RefluxAPIModule.RefluxAPI;
      } else if (window.RefluxAPIModule) {
        RefluxAPIClass = window.RefluxAPIModule;
      }
      
      if (!RefluxAPIClass) {
        console.error("RefluxAPIModule not found. Available on window:", Object.keys(window).filter(k => k.includes('Reflux')));
        console.log("RefluxAPIModule object:", window.RefluxAPIModule);
        return;
      }
      
      initializeAPI(RefluxAPIClass);
    };

    const initializeAPI = (RefluxAPIClass) => {
      if (typeof RefluxAPIClass !== 'function') {
        console.error("RefluxAPI is not a constructor. Type:", typeof RefluxAPIClass, "Value:", RefluxAPIClass);
        
        if (RefluxAPIClass && typeof RefluxAPIClass.RefluxAPI === 'function') {
          RefluxAPIClass = RefluxAPIClass.RefluxAPI;
        } else {
          return;
        }
      }

      try {
        console.log("Initializing RefluxAPI with constructor:", RefluxAPIClass.name);
        console.log("Control port available:", !!control.port2);
        
        const api = new RefluxAPIClass(control.port2);
        console.log("RefluxAPI instance created:", api);
        console.log("API methods available:", Object.getOwnPropertyNames(Object.getPrototypeOf(api)));

        console.log("Testing the new Plugin System...");
        
        const examplePlugin = {
          function: `
            /* @browser */
            console.log('ðŸš€ Example plugin executed on:', url);
            console.log('ðŸš€ Plugin name:', pluginName);
            /* @/browser */
          `,
          name: 'com.example.logger',
          sites: ['*']
        };
        
        console.log("Adding example plugin...");
        api.addPlugin(examplePlugin).then(() => {
          console.log("âœ… Example logger plugin added successfully!");
        }).catch(error => {
          console.error("âŒ Failed to add example plugin:", error);
        });

        const exampleComPlugin = {
          function: `
            /* @browser */
            console.log('ðŸŽ¯ Example.com plugin running on:', url);
            
            function enhanceExampleCom() {
              const h1Elements = document.querySelectorAll('h1');
              console.log('Found', h1Elements.length, 'h1 elements');
              
              h1Elements.forEach((h1, index) => {
                h1.style.cssText = 'color: #ff6b6b !important; background: #ffe066 !important; padding: 10px !important; border-radius: 5px !important; border: 2px solid #ff6b6b !important;';
                h1.innerHTML = 'ðŸš€ ENHANCED BY REFLUX: ' + h1.innerHTML;
                console.log('Enhanced h1 element', index + 1);
              });
              
              if (h1Elements.length === 0) {
                console.log('No h1 elements found, adding a banner instead');
                const banner = document.createElement('div');
                banner.innerHTML = 'ðŸš€ Reflux Plugin Active on Example.com!';
                banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff6b6b; color: white; padding: 10px; text-align: center; z-index: 10000; font-weight: bold;';
                document.body.appendChild(banner);
                document.body.style.marginTop = '50px';
              }
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', enhanceExampleCom);
            } else {
              enhanceExampleCom();
            }
            /* @/browser */
          `,
          name: 'com.example.example-com-enhancer',
          sites: ['example.com', 'www.example.com']
        };
        
        api.addPlugin(exampleComPlugin).then(() => {
          console.log("Example.com enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add Example.com plugin:", error);
        });

        const googlePlugin = {
          function: `
            if (body.includes('<title>')) {
              return body.replace('<title>', '<title>[MODIFIED BY REFLUX] ');
            }
            return body;
          `,
          name: 'com.example.google-modifier',
          sites: ['google.com', 'www.google.com']
        };
        
        api.addPlugin(googlePlugin).then(() => {
          console.log("Google modifier plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add Google plugin:", error);
        });

        const githubPlugin = {
          function: `
            if (body.includes('</head>')) {
              const customCSS = '<style>.reflux-banner {background: linear-gradient(90deg, #6366f1, #8b5cf6);color: white;text-align: center;padding: 10px;font-weight: bold;position: fixed;top: 0;left: 0;right: 0;z-index: 9999;}body { margin-top: 40px !important; }</style>';
              const banner = '<div class="reflux-banner">ðŸš€ Enhanced by Reflux Plugin System</div>';
              
              let modifiedBody = body.replace('</head>', customCSS + '</head>');
              
              const bodyTagMatch = modifiedBody.match(/<body[^>]*>/);
              if (bodyTagMatch) {
                const bodyTag = bodyTagMatch[0];
                modifiedBody = modifiedBody.replace(bodyTag, bodyTag + banner);
              }
              
              return modifiedBody;
            }
            return body;
          `,
          name: 'com.example.github-enhancer',
          sites: ['github.com']
        };

        api.addPlugin(githubPlugin).then(() => {
          console.log("GitHub enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add GitHub plugin:", error);
        });

        
        api.addPlugin(githubPlugin).then(() => {
          console.log("GitHub enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add GitHub plugin:", error);
        });


        const socialMediaPlugin = {
          function: `
            /* @browser */
            console.log('ðŸ“± Social media plugin activated on:', url);
            console.log('ðŸ“± Plugin:', pluginName);
            
            const socialBanner = document.createElement('div');
            socialBanner.innerHTML = 'ðŸ“± Social Media Enhanced by Reflux!';
            socialBanner.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; background: #8b5cf6; color: white; padding: 8px; text-align: center; z-index: 999999; font-size: 14px;';
            
            function addSocialEnhancements() {
              document.body.appendChild(socialBanner);
              console.log('ðŸ“± Social media enhancements added');
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', addSocialEnhancements);
            } else {
              addSocialEnhancements();
            }
            /* @/browser */
          `,
          name: 'com.example.social-enhancer',
          sites: [ 'www.instagram.com', 'instagram.com']
        };
        
        api.addPlugin(socialMediaPlugin).then(() => {
          console.log("Social media enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add social media plugin:", error);
        });

        setTimeout(() => {
          api.listPlugins().then(plugins => {
            console.log("Currently loaded plugins:", plugins);
          }).catch(error => {
            console.error("Failed to list plugins:", error);
          });
        }, 1000);

        const debugPlugin = {
          function: `
            /* @browser */
            console.log('ðŸ” DEBUG PLUGIN - URL:', url);
            console.log('ðŸ” DEBUG PLUGIN - Plugin:', pluginName);
            console.log('ðŸ” DEBUG PLUGIN - User Agent:', navigator.userAgent);
            console.log('ðŸ” DEBUG PLUGIN - Page Title:', document.title);
            console.log('ðŸ” DEBUG PLUGIN - DOM Ready State:', document.readyState);
            
            const debugIndicator = document.createElement('div');
            debugIndicator.innerHTML = 'ðŸ” DEBUG: Reflux Plugin Active';
            debugIndicator.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #ff0000; color: white; padding: 5px 10px; border-radius: 5px; z-index: 999999; font-size: 12px; font-family: monospace; border: 2px solid #ffffff;';
            
            // Add to page when DOM is ready
            function addDebugIndicator() {
              document.body.appendChild(debugIndicator);
              console.log('ðŸ” DEBUG PLUGIN - Visual indicator added');
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', addDebugIndicator);
            } else {
              addDebugIndicator();
            }
            /* @/browser */
          `,
          name: 'com.debug.all-sites',
          sites: ['*']
        };
        
        api.addPlugin(debugPlugin).then(() => {
          console.log("Debug plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add debug plugin:", error);
        });

        window.RefluxAPIInstance = api;
        console.log("RefluxAPI initialized successfully!");
        
      } catch (error) {
        console.error("Failed to initialize RefluxAPI:", error);
      }
    };

    if (window.RefluxAPIModule) {
      initializeRefluxAPI();
    } else {
      setTimeout(() => {
        initializeRefluxAPI();
      }, 100);
    }
  })();
</script>