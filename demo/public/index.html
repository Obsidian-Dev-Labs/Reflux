<!DOCTYPE html>
<html>

<head>
  <title>Dusk</title>
  <style>
    :root {
      --input-height: 48px;
    }

    @font-face {
      font-family: "Inter";
      src: url(./Inter.ttf);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      background-color: #1a1a1a;
      font-family: "Inter";
    }

    .top-bar {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 10px;
      gap: 6px;
    }

    .top-bar div {
      height: var(--input-height);
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      background-color: #ffffff28;
      border: 2px solid #ffffff28;
      border-radius: 10px;
      transition: 150ms ease-in-out;
    }

    .top-bar div.focused {
      border-color: #ffffff80;
    }

    .top-bar div:hover {
      border-color: #ffffff60;
    }

    .top-bar input {
      width: 100%;
      height: 100%;
      background-color: transparent;
      border: none;
      color: #ffffffcd;
      padding-left: 8px;
      font-weight: 600;
      font-size: 18px;
      line-height: 1;
      outline: none;
    }

    .top-bar input::placeholder {
      color: #ffffff80;
      font-weight: 450;
    }

    .top-bar button {
      display: flex;
      align-items: center;
      justify-content: center;
      height: max-content;
      margin-right: 4px;
      padding: 4px;
      background-color: #ffffff28;
      color: #ffffffcd;
      border: 2px solid #ffffff28;
      border-radius: 8px;
      font-weight: 550;
      font-size: 18px;
      cursor: pointer;
    }

    .top-bar button svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    .iframe-container {
      width: 100%;
      height: calc(100vh - 50px);
      position: relative;
    }

    #frame {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <script src="/baremux/index.js"></script>
  <script src="/scram/scramjet.all.js"></script>
  <script src="/reflux/api.js"></script>
</head>

<body>
  <div class="top-bar">
    <div>
      <input autofocus autocapitalize="false" id="input" type="text" placeholder="Enter something..." />
      <button>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd"
            d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z"
            clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <div class="iframe-container">
    <iframe id="frame" src="./home.html"></iframe>
  </div>
</body>

</html>

<script>
  (async () => {
    function search(input) {
      input = input.trim();
      const searchTemplate = "https://www.duckduckgo.com/?q=%s";
      try {
        return new URL(input).toString();
      } catch (err) {
        try {
          const url = new URL(`http://${input}`);
          if (url.hostname.includes(".")) {
            return url.toString();
          }
          throw new Error("Invalid hostname");
        } catch (err) {
          return searchTemplate.replace("%s", encodeURIComponent(input));
        }
      }
    }

    const { ScramjetController } = $scramjetLoadController();

    const scramjet = new ScramjetController({
      prefix: "/scram/route/",
      files: {
        wasm: "/scram/scramjet.wasm.wasm",
        all: "/scram/scramjet.all.js",
        sync: "/scram/scramjet.sync.js",
      },
      flags: {
        rewriterLogs: false,
      },
    });

    scramjet.init();
    navigator.serviceWorker.register("/sw.js");

    const inputcontainer = document.querySelector(".top-bar div");
    const input = document.getElementById("input");
    const frame = document.getElementById("frame");
    const enter = document.querySelector(".top-bar button");

    enter.addEventListener("click", function () {
      if (input.value) {
        const value = input.value.trim();
        const searchUrl = search(value);
        frame.src = "/ob/route/" + encodeURIComponent(search(searchUrl));
      }
    });

    input.addEventListener("focus", () => {
      inputcontainer.classList.add("focused");
    });

    input.addEventListener("blur", () => {
      inputcontainer.classList.remove("focused");
    });

    input.addEventListener("keypress", function (e) {
      if (e.target.value && e.key == "Enter") {
        e.preventDefault();
        const value = e.target.value.trim();
        const searchUrl = search(value);

        if (value) {
          frame.src = "/scram/route/" + encodeURIComponent(search(searchUrl));
        }
      }
    });

    const control = new MessageChannel();
    console.log("Created control channel:", control);

    const connection = new window.BareMux.BareMuxConnection(
      "/baremux/worker.js"
    );
    
    console.log("Setting transport with control port...");
    await connection.setTransport(
      "/reflux/index.mjs",
      [
        {
          transport: "/epoxy/index.mjs",
          wisp: "wss://gointospace.app/wisp/",
          controlPort: control.port1,
        },
      ],
      [control.port1]
    );
    console.log("Transport set successfully");

    const client = new window.BareMux.BareClient();
    const response = await client.fetch("https://example.com");
    console.log("Response from example.com:", await response.text());
    console.log("Full response object:", response);

    window.BMClient = client;
    window.BMConnection = connection;

    const initializeRefluxAPI = () => {
      let RefluxAPIClass = null;
      
      if (window.RefluxAPIModule && window.RefluxAPIModule.RefluxAPI) {
        RefluxAPIClass = window.RefluxAPIModule.RefluxAPI;
      } else if (window.RefluxAPIModule) {
        RefluxAPIClass = window.RefluxAPIModule;
      }
      
      if (!RefluxAPIClass) {
        console.error("RefluxAPIModule not found. Available on window:", Object.keys(window).filter(k => k.includes('Reflux')));
        console.log("RefluxAPIModule object:", window.RefluxAPIModule);
        return;
      }
      
      initializeAPI(RefluxAPIClass);
    };

    const initializeAPI = (RefluxAPIClass) => {
      if (typeof RefluxAPIClass !== 'function') {
        console.error("RefluxAPI is not a constructor. Type:", typeof RefluxAPIClass, "Value:", RefluxAPIClass);
        
        if (RefluxAPIClass && typeof RefluxAPIClass.RefluxAPI === 'function') {
          RefluxAPIClass = RefluxAPIClass.RefluxAPI;
        } else {
          return;
        }
      }

      try {
        console.log("Initializing RefluxAPI with constructor:", RefluxAPIClass.name);
        console.log("Control port available:", !!control.port2);
        
        const api = new RefluxAPIClass(control.port2);
        console.log("RefluxAPI instance created:", api);
        console.log("API methods available:", Object.getOwnPropertyNames(Object.getPrototypeOf(api)));

        console.log("Testing the new Plugin System...");
        
        const examplePlugin = {
          function: `
            /* @browser */
            console.log('üöÄ Example plugin executed on:', url);
            console.log('üöÄ Plugin name:', pluginName);
            /* @/browser */
          `,
          name: 'com.example.logger',
          sites: ['*']
        };
        
        console.log("Adding example plugin...");
        api.addPlugin(examplePlugin).then(() => {
          console.log("‚úÖ Example logger plugin added successfully!");
        }).catch(error => {
          console.error("‚ùå Failed to add example plugin:", error);
        });

        const exampleComPlugin = {
          function: `
            /* @browser */
            console.log('üéØ Example.com plugin running on:', url);
            
            function enhanceExampleCom() {
              const h1Elements = document.querySelectorAll('h1');
              console.log('Found', h1Elements.length, 'h1 elements');
              
              h1Elements.forEach((h1, index) => {
                h1.style.cssText = 'color: #ff6b6b !important; background: #ffe066 !important; padding: 10px !important; border-radius: 5px !important; border: 2px solid #ff6b6b !important;';
                h1.innerHTML = 'üöÄ ENHANCED BY REFLUX: ' + h1.innerHTML;
                console.log('Enhanced h1 element', index + 1);
              });
              
              if (h1Elements.length === 0) {
                console.log('No h1 elements found, adding a banner instead');
                const banner = document.createElement('div');
                banner.innerHTML = 'üöÄ Reflux Plugin Active on Example.com!';
                banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff6b6b; color: white; padding: 10px; text-align: center; z-index: 10000; font-weight: bold;';
                document.body.appendChild(banner);
                document.body.style.marginTop = '50px';
              }
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', enhanceExampleCom);
            } else {
              enhanceExampleCom();
            }
            /* @/browser */
          `,
          name: 'com.example.example-com-enhancer',
          sites: ['example.com', 'www.example.com']
        };
        
        api.addPlugin(exampleComPlugin).then(() => {
          console.log("Example.com enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add Example.com plugin:", error);
        });

        const googlePlugin = {
          function: `
            if (body.includes('<title>')) {
              return body.replace('<title>', '<title>[MODIFIED BY REFLUX] ');
            }
            return body;
          `,
          name: 'com.example.google-modifier',
          sites: ['google.com', 'www.google.com']
        };
        
        api.addPlugin(googlePlugin).then(() => {
          console.log("Google modifier plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add Google plugin:", error);
        });

        const githubPlugin = {
          function: `
            if (body.includes('</head>')) {
              const customCSS = '<style>.reflux-banner {background: linear-gradient(90deg, #6366f1, #8b5cf6);color: white;text-align: center;padding: 10px;font-weight: bold;position: fixed;top: 0;left: 0;right: 0;z-index: 9999;}body { margin-top: 40px !important; }</style>';
              const banner = '<div class="reflux-banner">üöÄ Enhanced by Reflux Plugin System</div>';
              
              let modifiedBody = body.replace('</head>', customCSS + '</head>');
              
              const bodyTagMatch = modifiedBody.match(/<body[^>]*>/);
              if (bodyTagMatch) {
                const bodyTag = bodyTagMatch[0];
                modifiedBody = modifiedBody.replace(bodyTag, bodyTag + banner);
              }
              
              return modifiedBody;
            }
            return body;
          `,
          name: 'com.example.github-enhancer',
          sites: ['github.com']
        };

        api.addPlugin(githubPlugin).then(() => {
          console.log("GitHub enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add GitHub plugin:", error);
        });

        
        api.addPlugin(githubPlugin).then(() => {
          console.log("GitHub enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add GitHub plugin:", error);
        });


        const socialMediaPlugin = {
          function: `
            /* @browser */
            console.log('üì± Social media plugin activated on:', url);
            console.log('üì± Plugin:', pluginName);
            
            const socialBanner = document.createElement('div');
            socialBanner.innerHTML = 'üì± Social Media Enhanced by Reflux!';
            socialBanner.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; background: #8b5cf6; color: white; padding: 8px; text-align: center; z-index: 999999; font-size: 14px;';
            
            function addSocialEnhancements() {
              document.body.appendChild(socialBanner);
              console.log('üì± Social media enhancements added');
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', addSocialEnhancements);
            } else {
              addSocialEnhancements();
            }
            /* @/browser */
          `,
          name: 'com.example.social-enhancer',
          sites: [ 'www.instagram.com', 'instagram.com']
        };
        
        api.addPlugin(socialMediaPlugin).then(() => {
          console.log("Social media enhancer plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add social media plugin:", error);
        });

        setTimeout(() => {
          api.listPlugins().then(plugins => {
            console.log("Currently loaded plugins:", plugins);
          }).catch(error => {
            console.error("Failed to list plugins:", error);
          });
        }, 1000);

        const debugPlugin = {
          function: `
            /* @browser */
            console.log('üîç DEBUG PLUGIN - URL:', url);
            console.log('üîç DEBUG PLUGIN - Plugin:', pluginName);
            console.log('üîç DEBUG PLUGIN - User Agent:', navigator.userAgent);
            console.log('üîç DEBUG PLUGIN - Page Title:', document.title);
            console.log('üîç DEBUG PLUGIN - DOM Ready State:', document.readyState);
            
            const debugIndicator = document.createElement('div');
            debugIndicator.innerHTML = 'üîç DEBUG: Reflux Plugin Active';
            debugIndicator.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #ff0000; color: white; padding: 5px 10px; border-radius: 5px; z-index: 999999; font-size: 12px; font-family: monospace; border: 2px solid #ffffff;';
            
            // Add to page when DOM is ready
            function addDebugIndicator() {
              document.body.appendChild(debugIndicator);
              console.log('üîç DEBUG PLUGIN - Visual indicator added');
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', addDebugIndicator);
            } else {
              addDebugIndicator();
            }
            /* @/browser */
          `,
          name: 'com.debug.all-sites',
          sites: ['*']
        };
        
        api.addPlugin(debugPlugin).then(() => {
          console.log("Debug plugin added successfully!");
        }).catch(error => {
          console.error("Failed to add debug plugin:", error);
        });

        // Example plugin that injects code based on constants
        const configBasedPlugin = {
          function: `
            // Configuration constants
            const PLUGIN_CONFIG = {
              injectType: 'css', // 'css', 'js', 'html', or 'mixed'
              cssCode: 'body { filter: sepia(0.3) !important; } h1 { color: #ff6b6b !important; }',
              jsCode: 'console.log("Custom JS injected!"); window.customFeature = true;',
              htmlCode: '<div id="custom-banner" style="background: #4CAF50; color: white; padding: 10px; text-align: center;">Custom HTML Banner</div>',
              targetSites: ['*'], // Sites where this should work
              position: 'head' // 'head', 'body-start', 'body-end'
            };
            
            // Server-side injection based on config
            if (body.includes('</head>') || body.includes('</body>')) {
              let modifiedBody = body;
              
              if (PLUGIN_CONFIG.injectType === 'css' || PLUGIN_CONFIG.injectType === 'mixed') {
                const cssTag = '<style>' + PLUGIN_CONFIG.cssCode + '</style>';
                modifiedBody = modifiedBody.replace('</head>', cssTag + '</head>');
              }
              
              if (PLUGIN_CONFIG.injectType === 'js' || PLUGIN_CONFIG.injectType === 'mixed') {
                const jsTag = '<script>' + PLUGIN_CONFIG.jsCode + '</script>';
                if (PLUGIN_CONFIG.position === 'head') {
                  modifiedBody = modifiedBody.replace('</head>', jsTag + '</head>');
                } else if (PLUGIN_CONFIG.position === 'body-end') {
                  modifiedBody = modifiedBody.replace('</body>', jsTag + '</body>');
                }
              }
              
              if (PLUGIN_CONFIG.injectType === 'html' || PLUGIN_CONFIG.injectType === 'mixed') {
                if (PLUGIN_CONFIG.position === 'body-start') {
                  const bodyMatch = modifiedBody.match(/<body[^>]*>/);
                  if (bodyMatch) {
                    modifiedBody = modifiedBody.replace(bodyMatch[0], bodyMatch[0] + PLUGIN_CONFIG.htmlCode);
                  }
                } else if (PLUGIN_CONFIG.position === 'body-end') {
                  modifiedBody = modifiedBody.replace('</body>', PLUGIN_CONFIG.htmlCode + '</body>');
                }
              }
              
              return modifiedBody;
            }
            
            /* @browser */
            // Browser-side configuration
            const BROWSER_CONFIG = {
              enableConsoleLog: true,
              showNotification: true,
              addCustomElements: true,
              customMessage: 'Plugin loaded with custom config!'
            };
            
            if (BROWSER_CONFIG.enableConsoleLog) {
              console.log('üîß Config-based plugin loaded on:', url);
              console.log('üîß Plugin config:', BROWSER_CONFIG);
            }
            
            if (BROWSER_CONFIG.showNotification) {
              const notification = document.createElement('div');
              notification.innerHTML = '‚öôÔ∏è ' + BROWSER_CONFIG.customMessage;
              notification.style.cssText = 'position: fixed; top: 50px; right: 10px; background: #2196F3; color: white; padding: 10px; border-radius: 5px; z-index: 999999; font-size: 14px; cursor: pointer;';
              
              // Auto-hide after 5 seconds
              notification.onclick = () => notification.remove();
              setTimeout(() => notification.remove(), 5000);
              
              function showNotification() {
                document.body.appendChild(notification);
              }
              
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showNotification);
              } else {
                showNotification();
              }
            }
            
            if (BROWSER_CONFIG.addCustomElements) {
              function addCustomElements() {
                // Add a floating action button
                const fab = document.createElement('div');
                fab.innerHTML = 'üöÄ';
                fab.style.cssText = 'position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(45deg, #FF6B6B, #4ECDC4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 999999; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
                
                fab.onclick = () => {
                  alert('Custom FAB clicked! Plugin is working.');
                };
                
                document.body.appendChild(fab);
                console.log('üîß Custom floating action button added');
              }
              
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', addCustomElements);
              } else {
                addCustomElements();
              }
            }
            /* @/browser */
            
            return body;
          `,
          name: 'com.example.config-based-injector',
          sites: ['*']
        };
        
        api.addPlugin(configBasedPlugin).then(() => {
          console.log("‚úÖ Config-based plugin added successfully!");
        }).catch(error => {
          console.error("‚ùå Failed to add config-based plugin:", error);
        });

        // Example of a simpler const-based plugin for specific use case
        const simpleConstPlugin = {
          function: `
            // Simple configuration
            const INJECT_DARK_MODE = true;
            const INJECT_CUSTOM_FONT = false;
            const SHOW_PAGE_INFO = true;
            
            if (body.includes('</head>')) {
              let injectedCSS = '';
              
              if (INJECT_DARK_MODE) {
                injectedCSS += 'body { background: #1a1a1a !important; color: #e0e0e0 !important; }';
                injectedCSS += 'a { color: #4CAF50 !important; }';
              }
              
              if (INJECT_CUSTOM_FONT) {
                injectedCSS += 'body { font-family: "Comic Sans MS", cursive !important; }';
              }
              
              let injectedJS = '';
              if (SHOW_PAGE_INFO) {
                injectedJS = 'console.log("Page loaded:", window.location.href, "Title:", document.title);';
              }
              
              if (injectedCSS) {
                body = body.replace('</head>', '<style>' + injectedCSS + '</style></head>');
              }
              
              if (injectedJS) {
                body = body.replace('</head>', '<script>' + injectedJS + '</script></head>');
              }
            }
            
            return body;
          `,
          name: 'com.example.simple-const-plugin',
          sites: ['example.com', 'httpbin.org']
        };
        
        api.addPlugin(simpleConstPlugin).then(() => {
          console.log("‚úÖ Simple const plugin added successfully!");
        }).catch(error => {
          console.error("‚ùå Failed to add simple const plugin:", error);
        });

        // Your navigation tracking plugin implemented correctly
        const injectable = `
(function () {
    if ((typeof window !== "object" || self.constructor !== Window) || window.parent === window) {
        return;
    }

    const notifyParentOfNavigation = (url) => {
        window.parent.postMessage({
            type: 'navigation',
            url: url,
            title: document.title || 'Loading...',
        }, window.location.origin);
    };

    if (window.navigation) {
        console.log('Using Navigation API.');
        window.navigation.addEventListener('navigate', (event) => {
            if (event.destination) {
                notifyParentOfNavigation(event.destination.url);
            }
        });
    }
    else {
        console.log('Using fallback for older browser.');
        const { pushState, replaceState } = history;

        history.pushState = function (state, title, url, ...rest) {
            if (url) {
                notifyParentOfNavigation(new URL(url, window.location.href).href);
            }
            return pushState.apply(history, [state, title, url, ...rest]);
        };

        history.replaceState = function (state, title, url, ...rest) {
            if (url) {
                notifyParentOfNavigation(new URL(url, window.location.href).href);
            }
            return replaceState.apply(history, [state, title, url, ...rest]);
        };

        window.addEventListener('popstate', () => {
            notifyParentOfNavigation(window.location.href);
        });

        window.addEventListener('hashchange', (event) => {
            notifyParentOfNavigation(event.newURL);
        });

        document.addEventListener('click', (event) => {
            const link = event.target.closest('a');
            if (link && link.href && link.getAttribute('href') && !link.href.startsWith('javascript:')) {
                if (link.target !== '_blank') {
                    notifyParentOfNavigation(link.href);
                }
            }
        }, true);

        document.addEventListener('submit', (event) => {
            const form = event.target.closest('form');
            if (form && form.action) {
                if (form.target !== '_blank') {
                    notifyParentOfNavigation(form.action);
                }
            }
        }, true);

        notifyParentOfNavigation(window.location.href);
    }
})();`;

        function buildPlugins() {
            return {
                function: `
                    /* @browser */
                    ${injectable}
                    /* @/browser */
                `,
                name: 'alora.base.functionality',
                sites: ['*']
            };
        }

        // Add the navigation tracking plugin
        const navigationPlugin = buildPlugins();
        
        api.addPlugin(navigationPlugin).then(() => {
          console.log("‚úÖ Navigation tracking plugin added successfully!");
        }).catch(error => {
          console.error("‚ùå Failed to add navigation plugin:", error);
        });

        window.RefluxAPIInstance = api;
        console.log("RefluxAPI initialized successfully!");
        
      } catch (error) {
        console.error("Failed to initialize RefluxAPI:", error);
      }
    };

    if (window.RefluxAPIModule) {
      initializeRefluxAPI();
    } else {
      setTimeout(() => {
        initializeRefluxAPI();
      }, 100);
    }
  })();
</script>